# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ CORS –∏ 502 Bad Gateway

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ —Å `https://playflon.com` –Ω–∞ `https://api.playflon.com/api/session/start` –≤–æ–∑–Ω–∏–∫–∞—é—Ç –¥–≤–µ –æ—à–∏–±–∫–∏:

1. **CORS –æ—à–∏–±–∫–∞**: `Access to fetch at 'https://api.playflon.com/api/session/start' from origin 'https://playflon.com' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: No 'Access-Control-Allow-Origin' header is present on the requested resource.`

2. **502 Bad Gateway**: `POST https://api.playflon.com/api/session/start net::ERR_FAILED`

## –ü—Ä–∏—á–∏–Ω—ã

1. **CORS**: Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`api.playflon.com.nginx.conf`) –Ω–µ —Å–æ–¥–µ—Ä–∂–∞–ª–∞ CORS –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è –¥–æ–º–µ–Ω–∞ `playflon.com`
2. **502 Bad Gateway**: 
   - –í nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±—ã–ª –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä `UPSTREAM_PORT` –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞
   - Backend –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3001

## –†–µ—à–µ–Ω–∏–µ

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx

–§–∞–π–ª `api.playflon.com.nginx.conf` –±—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω:

- ‚úÖ –ó–∞–º–µ–Ω–µ–Ω `UPSTREAM_PORT` –Ω–∞ `3001` (–ø–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Ä–∞–±–æ—Ç–∞–µ—Ç backend)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –¥–æ–º–µ–Ω–∞ `https://playflon.com`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ preflight OPTIONS –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ `http://127.0.0.1:3001`

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ backend

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3001:

```bash
cd backend
npm run dev
```

–î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
```
‚úÖ Firebase Admin –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
üöÄ Playflon Backend –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3001
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ health endpoint

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ backend –æ—Ç–≤–µ—á–∞–µ—Ç:

```bash
curl http://localhost:3001/health
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å—Å—è JSON:
```json
{"status":"ok","timestamp":"2024-12-30T..."}
```

### 4. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx –Ω—É–∂–Ω–æ:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å:
```bash
sudo nginx -t
```

2. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å nginx:
```bash
sudo systemctl reload nginx
# –∏–ª–∏
sudo nginx -s reload
```

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **CORS –≤ Nginx vs Backend**: 
   - CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ nginx, —Ç–∞–∫ –∫–∞–∫ nginx —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ–∫—Å–∏ –ø–µ—Ä–µ–¥ backend
   - Backend —Ç–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `cors()` middleware, –Ω–æ –¥–ª—è production –≤–∞–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å CORS –≤ nginx

2. **–ü–æ—Ä—Ç backend**: 
   - Backend –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ –ø–æ—Ä—Ç—É 3001 (—Å–º. `backend/src/index.ts`)
   - –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–æ–π –ø–æ—Ä—Ç, –æ–±–Ω–æ–≤–∏—Ç–µ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

3. **SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã**: 
   - –í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
   - –ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ certbot –æ–Ω–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. Backend –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3001
2. Nginx –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω —Å –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
3. –í –±—Ä–∞—É–∑–µ—Ä–µ DevTools (F12) ‚Üí Network –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - OPTIONS –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 204 —Å CORS –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
   - POST –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è
   - –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫ CORS –∏–ª–∏ 502

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–µ—Å–ª–∏ backend –Ω–∞ –¥—Ä—É–≥–æ–º –ø–æ—Ä—Ç—É)

–ï—Å–ª–∏ backend —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –¥—Ä—É–≥–æ–º –ø–æ—Ä—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 3000), –æ–±–Ω–æ–≤–∏—Ç–µ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

```nginx
proxy_pass http://127.0.0.1:3000;  # –≤–º–µ—Å—Ç–æ 3001
```

–ò —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `backend/.env` —É–∫–∞–∑–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—Ç:
```env
PORT=3000
```



